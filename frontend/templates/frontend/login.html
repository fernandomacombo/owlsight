{% load static %}
<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <title>Owlsight ‚Äî Login</title>

  <style>
    :root{
      --bg:#070707;
      --panel: rgba(18,18,18,.72);
      --panel2: rgba(12,12,12,.92);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --red:#E10600;
      --red2:#8A0000;
      --shadow: rgba(0,0,0,.65);
    }

    html,body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      overflow-y: auto;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      z-index:-3;
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(225,6,0,.18), transparent 60%),
        radial-gradient(800px 520px at 85% 12%, rgba(225,6,0,.10), transparent 58%),
        radial-gradient(950px 640px at 50% 110%, rgba(255,255,255,.06), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.60));
      filter: saturate(1.06);
      transform: translateZ(0);
    }

    body::after{
      content:"";
      position:fixed; inset:0;
      z-index:-2;
      background:
        repeating-linear-gradient(
          90deg,
          rgba(255,255,255,.03) 0px,
          rgba(255,255,255,.03) 1px,
          transparent 1px,
          transparent 14px
        );
      opacity:.10;
      pointer-events:none;
      mask-image: radial-gradient(70% 55% at 50% 20%, black 0%, transparent 72%);
    }

    .glow{
      position:fixed;
      inset:-40%;
      z-index:-1;
      background:
        radial-gradient(closest-side at 30% 20%, rgba(225,6,0,.35), transparent 65%),
        radial-gradient(closest-side at 75% 25%, rgba(225,6,0,.20), transparent 62%),
        radial-gradient(closest-side at 55% 90%, rgba(255,255,255,.10), transparent 68%);
      filter: blur(18px);
      opacity:.90;
      animation: glowMove 10s ease-in-out infinite;
      transform: translateZ(0);
    }
    @keyframes glowMove{
      0%   { transform: translate3d(-1.5%,-1.2%,0) scale(1.02); opacity:.85; }
      50%  { transform: translate3d( 1.5%, 1.3%,0) scale(1.06); opacity:1; }
      100% { transform: translate3d(-1.5%,-1.2%,0) scale(1.02); opacity:.85; }
    }

    .spark{
      position:fixed;
      width:6px; height:6px;
      border-radius:999px;
      background: rgba(225,6,0,.65);
      opacity:0;
      filter: blur(.2px);
      animation: spark 6s linear infinite;
      pointer-events:none;
      z-index:-1;
    }
    @keyframes spark{
      0%{ transform: translateY(40px) translateX(0) scale(.8); opacity:0; }
      15%{ opacity:.55; }
      70%{ opacity:.22; }
      100%{ transform: translateY(-420px) translateX(48px) scale(1.1); opacity:0; }
    }

    .glass{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 30px 100px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
    }
    .ring{
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06) inset,
        0 0 0 1px rgba(225,6,0,.14),
        0 30px 100px rgba(0,0,0,.55);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.70);
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      font-weight: 800;
      width: fit-content;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(225,6,0,.90);
      box-shadow: 0 0 0 8px rgba(225,6,0,.14);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(.9); box-shadow: 0 0 0 8px rgba(225,6,0,.12); }
      50%{ transform: scale(1.1); box-shadow: 0 0 0 12px rgba(225,6,0,.16); }
    }

    .inpt:focus{
      outline:none;
      box-shadow: 0 0 0 4px rgba(225,6,0,.14);
      border-color: rgba(225,6,0,.30);
    }

    .btn-red{
      background: linear-gradient(180deg, var(--red), var(--red2));
      box-shadow: 0 18px 40px rgba(225,6,0,.18);
      border: 1px solid rgba(225,6,0,.40);
    }
    .btn-red:hover{ filter: brightness(1.08); }

    .screen{ min-height: 100svh; }

    .social-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    .social-card{
      position: relative;
      border-radius: 16px;
      padding: 8px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      overflow:hidden;
      transition: transform .14s ease, border-color .14s ease, background .14s ease, filter .14s ease;
    }
    .social-card::before{
      content:"";
      position:absolute;
      inset:-45%;
      background:
        radial-gradient(closest-side at 25% 25%, rgba(225,6,0,.22), transparent 62%),
        radial-gradient(closest-side at 70% 25%, rgba(255,255,255,.10), transparent 60%);
      filter: blur(18px);
      opacity:.55;
      pointer-events:none;
      transform: translateZ(0);
    }
    .social-card:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.07);
      border-color: rgba(225,6,0,.22);
    }

    .social-top{
      position: relative;
      z-index: 1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .social-label{
      font-size: 11px;
      color: rgba(255,255,255,.60);
      font-weight: 500;
      letter-spacing: .10em;
      text-transform: uppercase;
    }
    .social-pill{
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.70);
    }

    .google-shell{
      position: relative;
      z-index: 1;
      width: 100%;
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 52px;
    }
    .google-shell > div{
      width: 100% !important;
      display:flex !important;
      align-items:center !important;
      justify-content:center !important;
    }
    .google-shell iframe{
      width: 100% !important;
      max-width: 100% !important;
    }

    .apple-btn{
      width: 100%;
      text-align:left;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap: 10px;
      background: transparent;
      border: 0;
      padding: 0;
      outline: none;
    }
    .apple-main{
      position: relative;
      z-index: 1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      min-height: 52px;
    }
    .apple-left{ display:flex; align-items:center; gap: 10px; }
    .apple-icon{
      width: 36px; height: 36px;
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 18px;
    }
    .apple-title{ font-weight: 900; color: rgba(255,255,255,.90); font-size: 14px; line-height: 1.1; }
    .apple-sub{ margin-top: 2px; color: rgba(255,255,255,.55); font-size: 12px; line-height: 1.1; }
    .apple-arrow{ color: rgba(255,255,255,.40); font-size: 18px; }

    @media (max-width: 520px){
      .social-grid{ grid-template-columns: 1fr; }
    }

    .enter{ animation: enter .45s ease-out both; }
    @keyframes enter{
      from{ opacity: 0; transform: translateY(8px); }
      to{ opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="text-white">
  <div class="glow"></div>

  <!-- sparks -->
  <span class="spark" style="left:10%; top:90%; animation-delay:0s;"></span>
  <span class="spark" style="left:18%; top:92%; animation-delay:1.1s;"></span>
  <span class="spark" style="left:44%; top:95%; animation-delay:2.2s;"></span>
  <span class="spark" style="left:72%; top:91%; animation-delay:1.6s;"></span>
  <span class="spark" style="left:88%; top:94%; animation-delay:2.8s;"></span>

  <div class="screen grid grid-rows-[auto,1fr]">

    <!-- Top bar -->
    <header class="max-w-6xl mx-auto w-full px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <img src="{% static 'frontend/images/logo.png' %}" alt="Owlsight" class="h-9 object-contain">
      </a>

      <a href="/"
         class="hidden sm:inline-flex px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-sm">
        Voltar
      </a>
    </header>

    <!-- Content -->
    <main class="max-w-6xl mx-auto w-full px-4 pb-6 grid lg:grid-cols-2 gap-8 items-center">

      <!-- Left -->
      <section class="order-2 lg:order-1">
        <div class="badge">
          <span class="dot"></span> Biblioteca premium
        </div>

        <h1 class="mt-4 text-3xl sm:text-4xl lg:text-5xl font-extrabold leading-tight">
          Bem-vindo ao <span style="color: rgba(225,6,0,.95);">Owlsight</span>
        </h1>

        <p class="mt-3 text-white/70 text-base leading-relaxed max-w-xl">
          Continua de onde paraste, guarda favoritos, avalia livros e acede a conte√∫dos premium
          com uma experi√™ncia estilo streaming.
        </p>

        <div class="mt-6 grid grid-cols-2 gap-4 max-w-xl">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-sm font-semibold">üìö Livros</div>
            <div class="text-xs text-white/60 mt-1">Explora por capas, estilo Netflix.</div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-sm font-semibold">‚≠ê Avalia√ß√µes</div>
            <div class="text-xs text-white/60 mt-1">V√™ ratings e deixa opini√£o.</div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-sm font-semibold">üîñ Favoritos</div>
            <div class="text-xs text-white/60 mt-1">Guarda e volta depois.</div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="text-sm font-semibold">üöÄ Progresso</div>
            <div class="text-xs text-white/60 mt-1">Continua na p√°gina certa.</div>
          </div>
        </div>
      </section>

      <!-- Right -->
      <section class="order-1 lg:order-2 w-full">
        <div class="max-w-md mx-auto rounded-2xl glass ring p-6 sm:p-7">
          <h2 class="text-2xl font-extrabold">Entrar</h2>
          <p class="text-sm text-white/60 mt-1">Acessa a tua conta para continuar.</p>

          <!-- Mensagem din√¢mica -->
          <div id="loginAlert" class="hidden mt-4 text-sm px-4 py-3 rounded-xl border border-white/10 bg-white/5"></div>

          <!-- Form -->
          <form id="loginForm" class="mt-5 space-y-4">
            {% csrf_token %}

            <div>
              <label class="text-sm text-white/70">Email ou Utilizador</label>
              <input id="username"
                     name="username"
                     autocomplete="username"
                     required
                     class="inpt mt-2 w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10"
                     placeholder="ex: fernando@owlsight.com" />
            </div>

            <div>
              <label class="text-sm text-white/70">Senha</label>
              <div class="mt-2 relative">
                <input id="password"
                       name="password"
                       type="password"
                       autocomplete="current-password"
                       required
                       class="inpt w-full px-4 py-3 pr-12 rounded-xl bg-black/30 border border-white/10"
                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                <button type="button"
                        onclick="togglePwd()"
                        class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 rounded-lg bg-white/10 hover:bg-white/15 border border-white/10 text-xs">
                  Ver
                </button>
              </div>
              <p class="text-xs text-white/45 mt-2">M√≠nimo 8 caracteres.</p>
            </div>

            <div class="flex items-center justify-between text-sm">
              <label class="flex items-center gap-2 text-white/70">
                <input id="rememberChk" type="checkbox" name="remember" class="accent-red-500">
                Lembrar-me
              </label>

              <a href="/forgot-password/" class="text-white/70 hover:text-white underline underline-offset-4 decoration-white/20">
                Esqueceu a senha?
              </a>
            </div>

            <button id="loginBtn"
                    type="submit"
                    class="w-full mt-1 px-4 py-3 rounded-xl btn-red font-semibold flex items-center justify-center gap-2">
              <span id="loginBtnText">Entrar</span>
              <span id="loginSpinner" class="hidden w-4 h-4 rounded-full border-2 border-white/60 border-t-transparent animate-spin"></span>
            </button>

            <div class="text-center text-sm text-white/60 mt-3">
              Ainda n√£o tens conta?
              <a href="/register/" class="text-white font-semibold underline underline-offset-4 decoration-white/20 hover:decoration-white/40">
                Criar conta
              </a>
            </div>
          </form>

          <!-- Divider -->
          <div class="mt-6 flex items-center gap-3">
            <div class="h-px bg-white/10 flex-1"></div>
            <div class="text-xs text-white/50">ou</div>
            <div class="h-px bg-white/10 flex-1"></div>
          </div>

          <!-- Social -->
          <div class="social-grid enter">
            <!-- Google -->
            <div class="social-card">
              <div class="social-top">
                <div class="social-label">Entrar com</div>
              </div>
              <div id="googleBtn" class="google-shell">
                <span class="text-white/70 text-sm">Google</span>
              </div>
            </div>

            <!-- Apple -->
            <div class="social-card">
              <button id="appleBtn" type="button" class="apple-btn">
                <div class="social-top">
                  <div class="social-label">Entrar com</div>
                </div>

                <div class="apple-main">
                      <div class="apple-title">Apple</div>
                    </div>
                  </div>
                  <div class="apple-arrow">‚Ä∫</div>
                </div>
              </button>
            </div>
          </div>
        </div>

        <p class="text-center text-xs text-white/40 mt-4">
          ¬© {% now "Y" %} Owlsight ‚Äî Todos os direitos reservados.
        </p>
      </section>
    </main>
  </div>

  <script>
    /* ========= UX ========= */
    function togglePwd(){
      const input = document.getElementById("password");
      input.type = (input.type === "password") ? "text" : "password";
    }

    function showAlert(text, type="error") {
      const box = document.getElementById("loginAlert");
      box.classList.remove("hidden");

      if (type === "success") {
        box.className = "mt-4 text-sm px-4 py-3 rounded-xl border border-green-500/20 bg-green-500/10 text-green-100";
      } else {
        box.className = "mt-4 text-sm px-4 py-3 rounded-xl border border-red-500/20 bg-red-500/10 text-red-100";
      }
      box.textContent = text;
    }

    function setLoading(on) {
      const btn = document.getElementById("loginBtn");
      const t = document.getElementById("loginBtnText");
      const sp = document.getElementById("loginSpinner");

      btn.disabled = on;
      if (on) {
        t.textContent = "Entrando...";
        sp.classList.remove("hidden");
        btn.classList.add("opacity-80", "cursor-not-allowed");
      } else {
        t.textContent = "Entrar";
        sp.classList.add("hidden");
        btn.classList.remove("opacity-80", "cursor-not-allowed");
      }
    }

    /* ========= Cookies/Fetch ========= */
    function getCookie(name) {
      const m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      return m ? decodeURIComponent(m[2]) : null;
    }

    function isUnsafe(method) {
      return ["POST", "PUT", "PATCH", "DELETE"].includes(method.toUpperCase());
    }

    async function apiFetch(url, options = {}) {
      const opts = { ...options };
      opts.credentials = "include";
      opts.headers = opts.headers || {};
      opts.headers["Accept"] = "application/json";

      const method = (opts.method || "GET").toUpperCase();
      if (isUnsafe(method)) {
        const csrf = getCookie("csrftoken");
        if (csrf) opts.headers["X-CSRFToken"] = csrf;
      }
      return fetch(url, opts);
    }

    /* ‚úÖ Garante CSRF cookie antes de qualquer POST */
    let CSRF_READY = false;
    async function ensureCsrf(){
      if (CSRF_READY) return;
      const res = await apiFetch("/api/csrf/");
      if (res.ok) CSRF_READY = true;
    }

    /* ‚úÖ Confirma que a sess√£o realmente ficou ativa */
    async function assertLoggedIn(){
      const r = await apiFetch("/api/auth/me/");
      if (!r.ok) return null;
      return r.json();
    }

    /* ========= Remember me (cliente) ========= */
    (function initRemember(){
      const saved = localStorage.getItem("owlsight_remember_username");
      if (saved) {
        document.getElementById("username").value = saved;
        const chk = document.getElementById("rememberChk");
        if (chk) chk.checked = true;
      }
    })();

    function applyRemember(username){
      const remember = document.getElementById("rememberChk").checked;
      if (remember) localStorage.setItem("owlsight_remember_username", username);
      else localStorage.removeItem("owlsight_remember_username");
      return remember;
    }

    /* ========= Login normal ========= */
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;

      if (!username || !password) {
        showAlert("Preencha todos os campos.");
        return;
      }
      if (password.length < 8) {
        showAlert("A senha deve ter pelo menos 8 caracteres.");
        return;
      }

      const remember = applyRemember(username);
      setLoading(true);

      try{
        await ensureCsrf();

        const res = await apiFetch("/api/auth/login/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, remember })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          setLoading(false);

          if (res.status === 403) {
            showAlert(data.detail || data.error || "403 (Forbidden). Verifica CSRF/Cookies/SameSite no backend.");
            return;
          }

          showAlert(data.error || data.detail || "Usu√°rio ou senha inv√°lidos.");
          return;
        }

        // ‚úÖ valida sess√£o antes de redirecionar
        const me = await assertLoggedIn();
        if (!me) {
          setLoading(false);
          showAlert("Login OK, mas a sess√£o n√£o ficou ativa (cookie bloqueado/dom√≠nio/SameSite).");
          return;
        }

        showAlert("Login efetuado com sucesso!", "success");

        const params = new URLSearchParams(window.location.search);
        const next = params.get("next");
        window.location.href = next || "/";

      } catch (err){
        setLoading(false);
        showAlert("Falha de rede/servidor ao entrar.");
      }
    });

    /* ========= Google Login ========= */
    const GOOGLE_CLIENT_ID = "{{ GOOGLE_CLIENT_ID|default:''|escapejs }}";

    async function onGoogleCredential(response){
      try{
        if(!response || !response.credential){
          showAlert("Falha no login Google.");
          return;
        }
        await ensureCsrf();

        const res = await apiFetch("/api/auth/google/", {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ credential: response.credential })
        });

        const data = await res.json().catch(() => ({}));
        if(!res.ok){
          showAlert(data.error || data.detail || "Erro ao autenticar com Google.");
          return;
        }

        const me = await assertLoggedIn();
        if(!me){
          showAlert("Google OK, mas a sess√£o n√£o ficou ativa (cookie/dom√≠nio/SameSite).");
          return;
        }

        const params = new URLSearchParams(window.location.search);
        const next = params.get("next");
        window.location.href = next || "/";

      } catch(e){
        showAlert("Erro ao entrar com Google.");
      }
    }

    function initGoogleLoginSafe() {
      const holder = document.getElementById("googleBtn");
      if (!holder) return;

      if (!GOOGLE_CLIENT_ID) {
        console.warn("GOOGLE_CLIENT_ID vazio. Configure no Railway (Variables).");
        holder.innerHTML = "<span class='text-white/70'>Google</span>";
        return;
      }

      if (!(window.google && google.accounts && google.accounts.id)) {
        setTimeout(initGoogleLoginSafe, 250);
        return;
      }

      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: onGoogleCredential,
        auto_select: false,
        cancel_on_tap_outside: true
      });

      holder.innerHTML = "";
      google.accounts.id.renderButton(holder, {
        theme: "outline",
        size: "large",
        width: holder.clientWidth
      });
    }

    initGoogleLoginSafe();
  </script>
</body>
</html>