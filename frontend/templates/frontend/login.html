{% extends "frontend/base.html" %}
{% load static %}
{% block title %}Owlsight ‚Äî Login{% endblock %}

{% block content %}
<section class="fade-in">
  <div class="max-w-5xl mx-auto grid lg:grid-cols-2 gap-6 items-center">
    <div class="hidden lg:block">
      <div class="glass soft-shadow rounded-3xl p-6">
        <div class="text-sm text-white/60 font-bold tracking-widest">BIBLIOTECA PREMIUM</div>
        <h1 class="mt-3 text-4xl font-extrabold leading-tight">
          Bem-vindo ao <span style="color: rgba(225,6,0,.95);">Owlsight</span>
        </h1>
        <p class="mt-3 text-white/70">
          Continua de onde paraste, guarda favoritos e acede a conte√∫dos premium.
        </p>

        <div class="mt-5 grid grid-cols-2 gap-3">
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-semibold text-sm">üìö Livros</div>
            <div class="text-xs text-white/60 mt-1">Explora por capas.</div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-semibold text-sm">‚≠ê Avalia√ß√µes</div>
            <div class="text-xs text-white/60 mt-1">V√™ e avalia.</div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-semibold text-sm">üîñ Favoritos</div>
            <div class="text-xs text-white/60 mt-1">Guarda e volta.</div>
          </div>
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
            <div class="font-semibold text-sm">üöÄ Progresso</div>
            <div class="text-xs text-white/60 mt-1">Retoma na p√°gina certa.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="glass soft-shadow rounded-3xl p-6 max-w-md mx-auto w-full">
      <h2 class="text-2xl font-extrabold">Entrar</h2>
      <p class="text-sm text-white/60 mt-1">Acessa a tua conta para continuar.</p>

      <div id="loginAlert" class="hidden mt-4 text-sm px-4 py-3 rounded-xl border border-white/10 bg-white/5"></div>

      <form id="loginForm" class="mt-5 space-y-4">
        {% csrf_token %}

        <div>
          <label class="text-sm text-white/70">Email ou Utilizador</label>
          <input id="username" name="username" autocomplete="username" required
                 class="input mt-2 w-full px-4 py-3 rounded-xl"
                 placeholder="ex: fernando@owlsight.com" />
        </div>

        <div>
          <label class="text-sm text-white/70">Senha</label>
          <input id="password" name="password" type="password" autocomplete="current-password" required
                 class="input mt-2 w-full px-4 py-3 rounded-xl"
                 placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <button class="btn-red w-full px-4 py-3 rounded-xl font-semibold" type="submit">
          Entrar
        </button>

        <div class="flex items-center justify-between text-sm mt-2">
          <a href="/forgot-password/" class="underline text-white/70">Esqueci a senha</a>
          <a href="/register/" class="underline text-white/70">Criar conta</a>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
function qs(name){
  const u = new URL(window.location.href);
  return u.searchParams.get(name);
}

function showAlert(text, ok=false){
  const box = document.getElementById("loginAlert");
  box.classList.remove("hidden");
  box.style.color = ok ? "rgba(34,197,94,.95)" : "rgba(225,6,0,.92)";
  box.textContent = text;
}

document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  await ensureCsrf();

  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  const res = await apiFetch("/api/auth/login/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  const data = await res.json().catch(() => ({}));
  if(!res.ok){
    showAlert(data.error || data.detail || "Falha no login.");
    return;
  }

  showAlert("Login feito com sucesso!", true);
  const next = qs("next") || "/";
  window.location.href = next;
});
</script>
{% endblock %}