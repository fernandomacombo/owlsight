{% extends "frontend/base.html" %}
{% block title %}Owlsight ‚Äî Livros{% endblock %}

{% block content %}
  <section class="fade-in">
    <div class="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-black tracking-tight">
          Cat√°logo
          <span style="color: rgba(225,6,0,.95);">Owlsight</span>
        </h1>
        <p class="text-sm mt-1" style="color: rgba(255,255,255,.62);">
          Preto. Vermelho. Branco. Um layout cinematogr√°fico ‚Äî r√°pido, limpo e profissional.
        </p>
      </div>

      <div class="flex gap-2 mt-3 md:mt-0">
        <input id="q" class="input px-3 py-2 rounded-xl text-sm w-full md:w-72"
               placeholder="Pesquisar t√≠tulo, autor, g√©nero..." />
        <button id="clearBtn" class="btn px-3 py-2 rounded-xl text-sm">Limpar</button>
      </div>
    </div>

    <div class="mt-5">
      <div id="books" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3"></div>
      <p id="msg" class="mt-4 text-sm" style="color: rgba(255,255,255,.62);"></p>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
<script>
function token(){ return localStorage.getItem("access"); }

function renderStars(avg){
  const full = Math.floor(avg);
  let stars = "";
  for(let i=1;i<=5;i++){ stars += (i <= full) ? "‚òÖ" : "‚òÜ"; }
  return stars;
}

async function loadProgress(){
  const t = token();
  if(!t) return {};
  const res = await fetch("/api/progress/me/", { headers: { "Authorization": "Bearer " + t } });
  if(!res.ok) return {};
  const arr = await res.json().catch(()=>[]);
  const map = {};
  for(const item of arr){ map[item.book_id] = item; }
  return map;
}

async function loadFavorites(){
  const t = token();
  if(!t) return new Set();
  const res = await fetch("/api/favorites/me/", { headers: { "Authorization": "Bearer " + t } });
  if(!res.ok) return new Set();
  const arr = await res.json().catch(()=>[]);
  return new Set(arr.map(x => x.book_id));
}

async function toggleFavorite(bookId){
  const t = token();
  if(!t){ window.location.href = "/login/"; return; }
  const res = await fetch(`/api/favorites/toggle/${bookId}/`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + t }
  });
  if(!res.ok){ alert("Erro ao favoritar."); return; }
  loadBooks();
}

async function rateBook(bookId, stars){
  const t = token();
  if(!t){ window.location.href = "/login/"; return; }

  const res = await fetch(`/api/ratings/${bookId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + t
    },
    body: JSON.stringify({ stars })
  });

  const data = await res.json().catch(()=>({}));
  if(!res.ok){
    alert(data.error || "Erro ao avaliar.");
    return;
  }
  loadBooks();
}

function rateStarsHTML(bookId){
  return `
    <div class="flex gap-1 mt-2">
      ${[1,2,3,4,5].map(s => `
        <button onclick="rateBook(${bookId}, ${s})"
          class="text-lg hover:scale-110 transition"
          style="color: rgba(225,6,0,.92)"
          title="Avaliar ${s} estrela(s)">‚òÖ</button>
      `).join("")}
    </div>
  `;
}

function cardHTML(b, p, isFav){
  const continuePage = p?.last_page || 1;
  const percent = p?.progress_percent || 0;

  const readers = b.readers_count ?? 0;
  const active = b.active_readers ?? 0;
  const avg = Number(b.avg_rating ?? 0);
  const rcount = b.ratings_count ?? 0;

  const badge = (b.book_type === "premium")
    ? `<span class="text-[11px] px-2 py-1 rounded-full" style="background: rgba(225,6,0,.14); border:1px solid rgba(225,6,0,.30); color: rgba(255,255,255,.92)">Premium</span>`
    : `<span class="text-[11px] px-2 py-1 rounded-full" style="background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.82)">Free</span>`;

  return `
    <div class="poster rounded-2xl overflow-hidden soft-shadow group">
      <div class="relative aspect-[3/4] overflow-hidden">
        ${b.cover
          ? `<img src="${b.cover}" class="w-full h-full object-cover group-hover:scale-[1.03] transition duration-200" />`
          : `<div class="w-full h-full grid place-items-center" style="color: rgba(255,255,255,.45)">Sem capa</div>`
        }

        <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition"
             style="background: linear-gradient(180deg, transparent, rgba(0,0,0,.85));"></div>

        <button onclick="toggleFavorite(${b.id})"
          class="absolute top-2 right-2 w-10 h-10 rounded-xl grid place-items-center transition
                 ${isFav ? "" : ""}"
          style="background: rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.14);">
          <span style="color:${isFav ? 'rgba(225,6,0,.95)' : 'rgba(255,255,255,.35)'}; font-size: 20px;">‚òÖ</span>
        </button>

        <div class="absolute bottom-0 left-0 right-0 p-3 opacity-0 group-hover:opacity-100 transition">
          <div class="flex items-center justify-between gap-2">
            ${badge}
            <div class="text-[11px]" style="color: rgba(255,255,255,.70)">
              üëÅÔ∏è <b>${readers}</b> ‚Ä¢ üî• <b>${active}</b>
            </div>
          </div>

          <div class="mt-2 text-sm font-bold leading-snug">${b.title}</div>
          <div class="text-xs" style="color: rgba(255,255,255,.70)">${b.author} ‚Ä¢ ${b.genre}</div>

          <div class="mt-2 text-xs" style="color: rgba(255,255,255,.70)">
            <span style="color: rgba(225,6,0,.92)">${renderStars(avg)}</span>
            <b>${avg}</b>/5 (${rcount})
          </div>

          ${token() ? rateStarsHTML(b.id) : `<div class="text-xs mt-2" style="color: rgba(255,255,255,.55)">Fa√ßa login para avaliar.</div>`}

          <div class="mt-3">
            <div class="flex justify-between text-[11px]" style="color: rgba(255,255,255,.65)">
              <span>Progresso</span>
              <span><b>${percent}%</b> ‚Ä¢ p√°g. <b>${continuePage}</b></span>
            </div>
            <div class="w-full rounded-full h-2 overflow-hidden mt-1" style="background: rgba(255,255,255,.10)">
              <div class="h-2" style="width:${percent}%; background: linear-gradient(90deg, rgba(225,6,0,.95), rgba(255,255,255,.18));"></div>
            </div>
          </div>

          <div class="mt-3 flex gap-2">
            <a class="flex-1 text-center px-3 py-2 rounded-xl text-sm font-semibold btn-red"
               href="/read/${b.id}/${continuePage}/">${continuePage > 1 ? "Continuar" : "Ler"}</a>
            <a class="px-3 py-2 rounded-xl text-sm btn text-center"
               href="/read/${b.id}/1/">Recome√ßar</a>
          </div>
        </div>
      </div>
    </div>
  `;
}

async function loadBooks(){
  const msg = document.getElementById("msg");
  const el = document.getElementById("books");
  msg.textContent = "A carregar...";
  el.innerHTML = "";

  const [progressMap, favSet, res] = await Promise.all([
    loadProgress(),
    loadFavorites(),
    fetch("/api/books/")
  ]);

  if(!res.ok){
    msg.textContent = "N√£o foi poss√≠vel carregar os livros.";
    return;
  }

  let books = await res.json().catch(()=>[]);
  const q = (document.getElementById("q").value || "").trim().toLowerCase();

  if(q){
    books = books.filter(b =>
      String(b.title||"").toLowerCase().includes(q) ||
      String(b.author||"").toLowerCase().includes(q) ||
      String(b.genre||"").toLowerCase().includes(q)
    );
  }

  if(!Array.isArray(books) || books.length === 0){
    msg.textContent = q ? "Sem resultados para a pesquisa." : "Ainda n√£o h√° livros cadastrados.";
    return;
  }

  msg.textContent = "";
  el.innerHTML = books.map(b => cardHTML(b, progressMap[b.id], favSet.has(b.id))).join("");
}

document.getElementById("q").addEventListener("input", () => loadBooks());
document.getElementById("clearBtn").onclick = () => {
  document.getElementById("q").value = "";
  loadBooks();
};

loadBooks();
</script>
{% endblock %}