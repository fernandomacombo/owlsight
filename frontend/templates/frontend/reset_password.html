{% extends "frontend/base.html" %}
{% block title %}Owlsight — Redefinir senha{% endblock %}

{% block content %}
<div class="max-w-md mx-auto fade-in">
  <div class="glass soft-shadow rounded-3xl p-5">
    <h1 class="text-2xl font-black">Redefinir senha</h1>
    <p class="text-sm mt-1" style="color: rgba(255,255,255,.62);">
      Digite duas vezes para evitar erro.
    </p>

    <div class="mt-4 grid gap-2">
      <input id="new_password" type="password" class="input px-3 py-2 rounded-xl" placeholder="Nova senha" />
      <input id="new_password2" type="password" class="input px-3 py-2 rounded-xl" placeholder="Confirmar nova senha" />

      <button id="btn" class="btn-red px-4 py-2 rounded-xl font-semibold">Salvar nova senha</button>
      <p id="msg" class="text-sm" style="color: rgba(225,6,0,.92);"></p>
    </div>

    <div class="mt-4 text-sm">
      <a href="/login/" class="underline" style="color: rgba(255,255,255,.72)">Voltar</a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

document.getElementById("btn").onclick = async () => {
  const uid = getParam("uid");
  const token = getParam("token");
  const p1 = document.getElementById("new_password").value;
  const p2 = document.getElementById("new_password2").value;

  const msg = document.getElementById("msg");
  msg.textContent = "";

  if(!p1 || p1.length < 6){
    msg.textContent = "A senha deve ter pelo menos 6 caracteres.";
    return;
  }
  if(p1 !== p2){
    msg.textContent = "As senhas não coincidem.";
    return;
  }

  const res = await fetch("/api/auth/reset-password/", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ uid, token, new_password: p1 })
  });

  const data = await res.json().catch(() => ({}));

  if(!res.ok){
    msg.textContent = data.error || "Erro ao redefinir senha.";
    return;
  }

  alert("Senha alterada! Agora faça login.");
  window.location.href = "/login/";
};
</script>
{% endblock %}