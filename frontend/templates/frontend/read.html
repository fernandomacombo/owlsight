{% extends "frontend/base.html" %}
{% block title %}Owlsight — Leitura{% endblock %}

{% block content %}
<section class="fade-in h-[100dvh] overflow-hidden">

  <!-- MOBILE TOP BAR -->
  <div class="lg:hidden flex items-center justify-between p-3">
    <button id="openDrawer" class="btn px-3 py-2 rounded-xl">☰</button>
    <div class="font-bold">Leitura</div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4 h-full">

    <!-- LEFT DRAWER -->
    <aside id="drawer"
           class="glass soft-shadow rounded-3xl p-4
                  fixed lg:relative
                  inset-y-0 left-0
                  w-[300px] lg:w-auto
                  z-50
                  transform -translate-x-full lg:translate-x-0
                  transition-transform duration-300
                  overflow-y-auto">

      <div class="flex justify-between items-center mb-3 lg:hidden">
        <div class="font-bold">Menu</div>
        <button id="closeDrawer" class="btn px-2 py-1 rounded-xl">✕</button>
      </div>

      <div id="header" class="flex gap-3"></div>

      <div class="mt-4 grid gap-2">
        <div class="flex gap-2">
          <button id="prevBtn" class="btn px-4 py-2 rounded-xl w-1/2">Anterior</button>
          <button id="nextBtn" class="btn-red px-4 py-2 rounded-xl w-1/2 font-semibold">Próxima</button>
        </div>

        <details class="mt-2 rounded-2xl p-3"
                 style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
          <summary class="text-sm">Debug</summary>
          <pre id="debugBox" class="text-xs"></pre>
        </details>
      </div>
    </aside>

    <!-- RIGHT -->
    <section class="glass soft-shadow rounded-3xl p-4 h-full">

      <div id="contentShell"
           class="relative w-full h-full overflow-hidden rounded-2xl">

        <div id="contentBox"
             class="w-full h-full flex items-center justify-center cursor-grab active:cursor-grabbing">
        </div>

      </div>

    </section>
  </div>
</section>

<style>
#contentBox img{
  max-width:none;
  max-height:none;
  user-select:none;
  -webkit-user-drag:none;
  transform-origin:center center;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
/* =========================
   Drawer mobile
========================= */
const drawer = document.getElementById("drawer")
document.getElementById("openDrawer")?.addEventListener("click",()=>{
  drawer.classList.remove("-translate-x-full")
})
document.getElementById("closeDrawer")?.addEventListener("click",()=>{
  drawer.classList.add("-translate-x-full")
})

/* =========================
   Zoom Inteligente
========================= */
let scale = 1
let posX = 0
let posY = 0
let isDragging = false
let startX = 0
let startY = 0

const contentBox = document.getElementById("contentBox")

function applyTransform(){
  const img = contentBox.querySelector("img")
  if(!img) return
  img.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`
}

function enableZoom(img){

  // mouse wheel zoom
  img.addEventListener("wheel",(e)=>{
    e.preventDefault()
    const delta = e.deltaY < 0 ? 0.1 : -0.1
    scale = Math.min(Math.max(1, scale + delta), 4)
    applyTransform()
  })

  // drag
  img.addEventListener("mousedown",(e)=>{
    isDragging = true
    startX = e.clientX - posX
    startY = e.clientY - posY
  })

  window.addEventListener("mouseup",()=> isDragging = false)

  window.addEventListener("mousemove",(e)=>{
    if(!isDragging) return
    posX = e.clientX - startX
    posY = e.clientY - startY
    applyTransform()
  })

  // touch drag
  img.addEventListener("touchstart",(e)=>{
    if(e.touches.length === 1){
      isDragging = true
      startX = e.touches[0].clientX - posX
      startY = e.touches[0].clientY - posY
    }
  })

  img.addEventListener("touchmove",(e)=>{
    if(e.touches.length === 1 && isDragging){
      posX = e.touches[0].clientX - startX
      posY = e.touches[0].clientY - startY
      applyTransform()
    }
  })

  img.addEventListener("touchend",()=> isDragging = false)

  // double click reset
  img.addEventListener("dblclick",()=>{
    scale = 1
    posX = 0
    posY = 0
    applyTransform()
  })
}

/* =========================
   Leitura
========================= */
const bookId = Number("{{ book_id }}")
let page = Number("{{ page_number }}")

async function loadPage(){
  const res = await fetch(`/api/read/${bookId}/${page}/`)
  const data = await res.json()

  document.getElementById("debugBox").textContent =
    JSON.stringify(data,null,2)

  const img = new Image()
  img.src = data.page_image
  img.className = "rounded-2xl"

  img.onload = ()=>{
    contentBox.innerHTML = ""
    contentBox.appendChild(img)
    enableZoom(img)
  }
}

document.getElementById("prevBtn").onclick = ()=>{
  if(page>1){ page--; loadPage() }
}

document.getElementById("nextBtn").onclick = ()=>{
  page++; loadPage()
}

loadPage()
</script>
{% endblock %}