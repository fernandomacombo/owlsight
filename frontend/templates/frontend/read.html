{% extends "frontend/base.html" %}
{% block title %}Owlsight ‚Äî Leitura{% endblock %}

{% block content %}
<section class="fade-in">
  <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4">

    <!-- LEFT -->
    <aside class="glass soft-shadow rounded-3xl p-4">
      <div class="flex items-start justify-between gap-3">
        <div id="header" class="flex gap-3 flex-1"></div>

        <a href="/logout/" class="btn px-3 py-2 rounded-xl text-sm">Sair</a>
      </div>

      <div class="mt-4 grid gap-2">
        <div class="flex gap-2">
          <button id="prevBtn" class="btn px-4 py-2 rounded-xl w-1/2">Anterior</button>
          <button id="nextBtn" class="btn-red px-4 py-2 rounded-xl w-1/2 font-semibold">Pr√≥xima</button>
        </div>

        <p id="msg" class="text-sm" style="color: rgba(225,6,0,.92);"></p>

        <div id="blocker" class="hidden rounded-2xl p-3"
             style="background: rgba(225,6,0,.10); border:1px solid rgba(225,6,0,.26);"></div>

        <!-- ‚úÖ Debug (para voc√™ ver o que o backend est√° mandando) -->
        <details class="mt-2 rounded-2xl p-3"
                 style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
          <summary class="text-sm" style="color: rgba(255,255,255,.75)">Debug (resposta do servidor)</summary>
          <pre id="debugBox" class="mt-2 text-xs whitespace-pre-wrap" style="color: rgba(255,255,255,.65)"></pre>
        </details>
      </div>
    </aside>

    <!-- RIGHT -->
    <section class="glass soft-shadow rounded-3xl p-4">
      <div id="contentShell" class="relative rounded-2xl overflow-hidden">
        <div id="contentBox" class="rounded-2xl overflow-hidden"></div>

        <!-- Watermark overlay -->
        <div id="wmOverlay"
             class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-200"></div>

        <!-- Blur ao trocar de aba -->
        <div id="privacyBlur"
             class="hidden absolute inset-0 backdrop-blur-2xl"
             style="background: rgba(0,0,0,.35);">
          <div class="h-full w-full grid place-items-center">
            <div class="text-center">
              <div class="text-xl font-black">Conte√∫do protegido</div>
              <div class="text-sm mt-1" style="color: rgba(255,255,255,.70)">
                Volte para a aba para continuar a leitura.
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>
</section>

<style>
  #contentShell, #contentShell *{ -webkit-user-select:none; user-select:none; }
  img{ -webkit-user-drag:none; user-drag:none; }
</style>
{% endblock %}

{% block extra_js %}
<script>
/* =========================
   CSRF + fetch (independente do base.html)
   ========================= */
function getCookie(name){
  const v = document.cookie.split(";").map(s=>s.trim());
  for(const c of v){
    if(c.startsWith(name+"=")) return decodeURIComponent(c.slice(name.length+1));
  }
  return null;
}
async function apiFetch(url, opts={}){
  const headers = new Headers(opts.headers || {});
  // envia cookies (session)
  opts.credentials = "same-origin";
  // CSRF s√≥ em m√©todos que alteram estado
  const method = (opts.method || "GET").toUpperCase();
  if(["POST","PUT","PATCH","DELETE"].includes(method)){
    const csrf = getCookie("csrftoken");
    if(csrf) headers.set("X-CSRFToken", csrf);
  }
  opts.headers = headers;
  return fetch(url, opts);
}

/* =========================
   Anti-c√≥pia (dificulta)
   ========================= */
(function harden(){
  document.addEventListener("contextmenu", (e)=>{ if(e.target.closest("#contentShell")) e.preventDefault(); });
  document.addEventListener("dragstart", (e)=>{ if(e.target.closest("#contentShell")) e.preventDefault(); });
  document.addEventListener("keydown", (e)=>{
    const key = (e.key||"").toLowerCase();
    const ctrl = e.ctrlKey || e.metaKey;
    if(key === "printscreen") e.preventDefault();
    if(!ctrl) return;
    if(["s","p","c","u"].includes(key)) e.preventDefault();
    if(e.shiftKey && ["i","j","c"].includes(key)) e.preventDefault();
  });
  const blur = document.getElementById("privacyBlur");
  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden) blur.classList.remove("hidden");
    else blur.classList.add("hidden");
  });
})();

/* =========================
   Watermark
   ========================= */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function setWatermarkOverlay({ bookTitle, pageNum, userLabel }){
  const overlay = document.getElementById("wmOverlay");
  const text = `${bookTitle} ‚Ä¢ ${userLabel} ‚Ä¢ p.${pageNum} ‚Ä¢ Owlsight`;
  const safe = escapeHtml(text);

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="640" height="420">
    <defs><style>
      .t{font-family: Arial, sans-serif; font-size: 18px; fill: rgba(255,255,255,0.12);}
    </style></defs>
    <g transform="translate(40,250) rotate(-24)">
      <text x="0" y="0" class="t">${safe}</text>
      <text x="0" y="42" class="t">${safe}</text>
      <text x="0" y="84" class="t">${safe}</text>
    </g>
  </svg>`.trim();

  const dataUrl = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  overlay.style.backgroundImage = `url("${dataUrl}")`;
  overlay.style.backgroundRepeat = "repeat";
  overlay.style.backgroundSize = "640px 420px";
  overlay.style.opacity = "1";
}

/* =========================
   Leitura
   ========================= */
const bookId = Number("{{ book_id }}");
let page = Number("{{ page_number }}");
let maxPages = 1;

async function fetchMe(){
  const res = await apiFetch("/api/auth/me/");
  if(!res.ok) return null;
  return res.json().catch(()=>null);
}

function pick(data, keys, fallback=null){
  for(const k of keys){
    if(data && data[k] !== undefined && data[k] !== null && data[k] !== "") return data[k];
  }
  return fallback;
}

async function loadPage(){
  const debugBox = document.getElementById("debugBox");
  const msg = document.getElementById("msg");
  const contentBox = document.getElementById("contentBox");
  const blocker = document.getElementById("blocker");

  msg.textContent = "";
  blocker.classList.add("hidden");
  contentBox.innerHTML = `<div class="p-10 text-center" style="color: rgba(255,255,255,.65)">Carregando...</div>`;

  const me = await fetchMe();
  if(!me){
    window.location.href = `/login/?next=${encodeURIComponent(window.location.pathname)}`;
    return;
  }

  const res = await apiFetch(`/api/read/${bookId}/${page}/`);
  const data = await res.json().catch(()=>({}));

  // ‚úÖ mostra sempre o JSON no debug
  debugBox.textContent = JSON.stringify({ status: res.status, data }, null, 2);

  // üîÅ Aceita v√°rios nomes poss√≠veis que o backend pode estar mandando
  const totalPages = Number(pick(data, ["total_pages","totalPages","pages_total","pages","total"], 0)) || 0;
  const limitPage  = Number(pick(data, ["allowed_until_page","limit_until_page","allowedUntilPage","limitPage","allowed_until","limit_until"], 0)) || 0;

  const bookTitle = pick(data, ["book","title","book_title","name"], "Livro");
  const bookType  = pick(data, ["book_type","type","tier"], "");

  const coverUrl  = pick(data, ["cover","cover_url","book_cover","coverImage","cover_image"], "");
  const pageImg   = pick(data, ["page_image","pageImage","image","image_url","img","url","page_url"], "");

  if(totalPages > 0) maxPages = totalPages;

  // Header
  document.getElementById("header").innerHTML = `
    <div class="w-24 aspect-[3/4] rounded-2xl overflow-hidden poster" style="border:1px solid rgba(255,255,255,.10)">
      ${coverUrl ? `<img src="${coverUrl}" class="w-full h-full object-cover" draggable="false" />`
                 : `<div class="w-full h-full grid place-items-center text-xs" style="color: rgba(255,255,255,.45)">Sem capa</div>`}
    </div>
    <div class="flex-1">
      <div class="font-black text-lg leading-tight">${escapeHtml(bookTitle)}</div>
      <div class="text-xs mt-1" style="color: rgba(255,255,255,.65)">
        Tipo: <b>${escapeHtml(String(bookType).toUpperCase())}</b>
      </div>
      <div class="text-xs mt-2" style="color: rgba(255,255,255,.60)">
        Folha <b>${page}</b>
        ‚Ä¢ Limite: <b>${limitPage || "-"}</b>
        ‚Ä¢ Total: <b>${totalPages || "-"}</b>
      </div>
    </div>
  `;

  // Bloqueio (o backend decide)
  if(res.status === 403 && data.blocked){
    contentBox.innerHTML = `
      <div class="p-10 text-center">
        <div class="text-xl font-black">Conte√∫do bloqueado</div>
        <div class="text-sm mt-2" style="color: rgba(255,255,255,.62)">
          ${escapeHtml(data.message || "Acesso limitado.")}
        </div>
      </div>
    `;
    const cta = data.cta || "share";
    blocker.innerHTML = `
      <div class="font-bold">Para continuar:</div>
      <div class="text-sm mt-1" style="color: rgba(255,255,255,.72)">${escapeHtml(data.message || "")}</div>
      ${
        cta === "pay"
        ? `<button class="btn-red mt-3 w-full px-4 py-2 rounded-xl font-semibold" onclick="payPlan('yearly')">Pagar</button>`
        : `<button class="btn-red mt-3 w-full px-4 py-2 rounded-xl font-semibold" onclick="share()">Partilhar link</button>`
      }
    `;
    blocker.classList.remove("hidden");

    setWatermarkOverlay({
      bookTitle,
      pageNum: page,
      userLabel: (me.email || me.username || me.user || me.name || "user")
    });
    return;
  }

  // Se n√£o veio imagem, avisa claramente (e o debug vai mostrar o motivo)
  if(!pageImg){
    contentBox.innerHTML = `
      <div class="p-10 text-center">
        <div class="text-lg font-black">N√£o veio a imagem da p√°gina</div>
        <div class="text-sm mt-2" style="color: rgba(255,255,255,.65)">
          O backend precisa enviar <b>page_image</b> (ou outro nome equivalente).
          Veja no Debug acima quais campos est√£o vindo.
        </div>
      </div>
    `;
    return;
  }

  // Render da p√°gina
  contentBox.innerHTML = `<img src="${pageImg}" class="w-full rounded-2xl" draggable="false" />`;

  setWatermarkOverlay({
    bookTitle,
    pageNum: page,
    userLabel: (me.email || me.username || me.user || me.name || "user")
  });
}

// Navega√ß√£o
document.getElementById("prevBtn").onclick = () => { if(page > 1){ page--; loadPage(); } };
document.getElementById("nextBtn").onclick = () => {
  if(page < maxPages){ page++; loadPage(); }
  else alert("Voc√™ chegou ao final do livro.");
};

// A√ß√µes (mant√©m, mas s√≥ funciona se teus endpoints existirem)
async function payPlan(plan){
  const res = await apiFetch("/api/pay/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ plan })
  });
  const data = await res.json().catch(()=>({}));
  if(!res.ok){ alert(data.error || "Erro ao pagar"); return; }
  loadPage();
}
async function share(){
  const url = window.location.href;
  try{ await navigator.clipboard.writeText(url); }catch(e){ prompt("Copie o link:", url); }
  const res = await apiFetch(`/api/unlock/share/${bookId}/`, { method:"POST" });
  const data = await res.json().catch(()=>({}));
  alert(data.message || "Partilha registrada!");
  loadPage();
}

// Start
loadPage();
</script>
{% endblock %}