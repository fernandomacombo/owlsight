{% extends "frontend/base.html" %}
{% block title %}Owlsight ‚Äî Leitura{% endblock %}

{% block content %}
<section class="fade-in">

  <!-- ‚úÖ Navbar pr√≥pria desta p√°gina (max-w-7xl) -->
  <header class="w-full">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
      <a href="/" class="flex items-center gap-2 select-none">
        <div class="w-9 h-9 rounded-xl grid place-items-center"
             style="background: rgba(225,6,0,.12); border:1px solid rgba(225,6,0,.25); color: rgba(255,255,255,.92);">
          ü¶â
        </div>
        <div class="font-black tracking-tight" style="color: rgba(255,255,255,.92);">Owlsight</div>
      </a>

      <!-- Desktop menu -->
      <nav class="hidden md:flex items-center gap-2">
        <a href="/" class="btn px-4 py-2 rounded-xl text-sm">P√°gina inicial</a>
        <a href="/profile/" class="btn px-4 py-2 rounded-xl text-sm">Conta</a>
        <a href="/favorites/" class="btn px-4 py-2 rounded-xl text-sm">Favoritos</a>
        <a href="/categories/" class="btn px-4 py-2 rounded-xl text-sm">Categoria</a>
      </nav>

      <!-- Mobile hamburger -->
      <button id="openDrawerBtn" class="md:hidden btn px-4 py-2 rounded-xl text-sm">‚ò∞ Menu</button>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 pb-6">
    <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4">

      <!-- LEFT (Desktop) -->
      <aside class="hidden lg:block glass soft-shadow rounded-3xl p-4" id="leftPanelDesktop">
        <div class="flex items-start justify-between gap-3">
          <div id="header" class="flex gap-3 flex-1"></div>
        </div>

        <div class="mt-4 grid gap-2">
          <!-- ‚úÖ Nav + mensagem (sem repetir zoom aqui) -->
          <div class="rounded-2xl p-3"
               style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
            <div class="flex gap-2">
              <button id="prevBtn" class="btn px-4 py-2 rounded-xl w-1/2">Anterior</button>
              <button id="nextBtn" class="btn-red px-4 py-2 rounded-xl w-1/2 font-semibold">Pr√≥xima</button>
            </div>

            <p id="msg" class="text-sm mt-2" style="color: rgba(225,6,0,.92);"></p>

            <!-- Bloqueio (pay/share) vindo do backend, se existir -->
            <div id="blocker" class="hidden mt-2 rounded-2xl p-3"
                 style="background: rgba(225,6,0,.10); border:1px solid rgba(225,6,0,.26);"></div>
          </div>

          <!-- Coment√°rios -->
          <div class="mt-2 rounded-2xl p-3"
               style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold" style="color: rgba(255,255,255,.82)">Coment√°rios</div>
              <span id="commentCount" class="text-xs" style="color: rgba(255,255,255,.55)">0</span>
            </div>

            <div id="commentsList" class="mt-2 grid gap-2"></div>

            <textarea id="commentText" rows="3"
              class="mt-3 w-full rounded-xl p-3 text-sm"
              placeholder="Escreva um coment√°rio‚Ä¶"
              style="background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); color: rgba(255,255,255,.92)"></textarea>

            <button id="addCommentBtn" class="btn-red mt-2 w-full px-4 py-2 rounded-xl text-sm font-semibold">
              Publicar coment√°rio
            </button>
          </div>

          <!-- Debug -->
          <details class="mt-2 rounded-2xl p-3"
                   style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
            <summary class="text-sm" style="color: rgba(255,255,255,.75)">Debug (resposta do servidor)</summary>
            <pre id="debugBox" class="mt-2 text-xs whitespace-pre-wrap" style="color: rgba(255,255,255,.65)"></pre>
          </details>
        </div>
      </aside>

      <!-- Drawer (Mobile) -->
      <div id="drawerOverlay" class="fixed inset-0 hidden lg:hidden"
           style="background: rgba(0,0,0,.55); z-index: 80;"></div>

      <aside id="drawerPanel"
             class="fixed top-0 left-0 h-full w-[92%] max-w-[420px] hidden lg:hidden p-4"
             style="z-index: 90;">
        <div class="glass soft-shadow rounded-3xl p-4 h-full overflow-auto">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-center gap-2">
              <div class="w-9 h-9 rounded-xl grid place-items-center"
                   style="background: rgba(225,6,0,.12); border:1px solid rgba(225,6,0,.25); color: rgba(255,255,255,.92);">
                ü¶â
              </div>
              <div class="font-black" style="color: rgba(255,255,255,.92);">Owlsight</div>
            </div>
            <button id="closeDrawerBtn" class="btn px-3 py-2 rounded-xl text-sm">‚úï</button>
          </div>

          <!-- ‚úÖ Menu escondido (Mobile) -->
          <div class="mt-4 rounded-2xl p-3"
               style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
            <div class="text-sm font-semibold" style="color: rgba(255,255,255,.82)">Menu</div>
            <div class="mt-2 grid gap-2">
              <a href="/" class="btn px-4 py-2 rounded-xl text-sm">P√°gina inicial</a>
              <a href="/profile/" class="btn px-4 py-2 rounded-xl text-sm">Conta</a>
              <a href="/favorites/" class="btn px-4 py-2 rounded-xl text-sm">Favoritos</a>
              <a href="/categories/" class="btn px-4 py-2 rounded-xl text-sm">Categoria</a>
            </div>
          </div>

          <!-- Header mobile (capa/t√≠tulo) -->
          <div class="mt-4 rounded-2xl p-3"
               style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
            <div id="headerMobile" class="flex gap-3"></div>

            <div class="mt-3 flex gap-2">
              <button id="prevBtnM" class="btn px-4 py-2 rounded-xl w-1/2">Anterior</button>
              <button id="nextBtnM" class="btn-red px-4 py-2 rounded-xl w-1/2 font-semibold">Pr√≥xima</button>
            </div>

            <p id="msgM" class="text-sm mt-2" style="color: rgba(225,6,0,.92);"></p>

            <div id="blockerM" class="hidden mt-2 rounded-2xl p-3"
                 style="background: rgba(225,6,0,.10); border:1px solid rgba(225,6,0,.26);"></div>
          </div>

          <!-- ‚úÖ Coment√°rios no drawer -->
          <div class="mt-4 rounded-2xl p-3"
               style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold" style="color: rgba(255,255,255,.82)">Coment√°rios</div>
              <span id="commentCountM" class="text-xs" style="color: rgba(255,255,255,.55)">0</span>
            </div>

            <div id="commentsListM" class="mt-2 grid gap-2"></div>

            <textarea id="commentTextM" rows="3"
              class="mt-3 w-full rounded-xl p-3 text-sm"
              placeholder="Escreva um coment√°rio‚Ä¶"
              style="background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); color: rgba(255,255,255,.92)"></textarea>

            <button id="addCommentBtnM" class="btn-red mt-2 w-full px-4 py-2 rounded-xl text-sm font-semibold">
              Publicar coment√°rio
            </button>
          </div>

          <!-- Debug mobile -->
          <details class="mt-4 rounded-2xl p-3"
                   style="border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04)">
            <summary class="text-sm" style="color: rgba(255,255,255,.75)">Debug (resposta do servidor)</summary>
            <pre id="debugBoxM" class="mt-2 text-xs whitespace-pre-wrap" style="color: rgba(255,255,255,.65)"></pre>
          </details>
        </div>
      </aside>

      <!-- RIGHT -->
      <section class="glass soft-shadow rounded-3xl p-0 lg:p-4" id="rightPanel">

        <!-- ‚úÖ Toolbar no topo do viewer (zoom + anotar + m√£o) -->
        <div class="flex items-center justify-between gap-2 px-4 py-4">
          <div class="flex items-center gap-2">
            <button id="panToggleBtn" class="btn px-4 py-2 rounded-xl text-sm">M√£o: OFF</button>
            <button id="annotateToggleBtn" class="btn px-4 py-2 rounded-xl text-sm">Anotar: OFF</button>
          </div>
          <div class="flex items-center gap-2">
            <button id="zoomOutBtnR" class="btn px-3 py-2 rounded-xl text-sm">‚àí</button>
            <button id="zoomInBtnR" class="btn px-3 py-2 rounded-xl text-sm">+</button>
            <button id="resetBtnR" class="btn px-3 py-2 rounded-xl text-sm">100%</button>
          </div>
        </div>

        <div id="contentShell"
             class="relative rounded-2xl overflow-hidden lg:overflow-auto"
             style="max-height: calc(100vh - 12.5rem);">
          <div id="viewer" class="relative w-full h-full">
            <div id="contentBox" class="rounded-2xl"></div>
          </div>

          <!-- Watermark overlay -->
          <div id="wmOverlay"
               class="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-200"></div>

          <!-- Blur ao trocar de aba -->
          <div id="privacyBlur"
               class="hidden absolute inset-0 backdrop-blur-2xl"
               style="background: rgba(0,0,0,.35);">
            <div class="h-full w-full grid place-items-center">
              <div class="text-center">
                <div class="text-xl font-black">Conte√∫do protegido</div>
                <div class="text-sm mt-1" style="color: rgba(255,255,255,.70)">
                  Volte para a aba para continuar a leitura.
                </div>
              </div>
            </div>
          </div>
        </div>

      </section>
    </div>
  </div>
</section>

<style>
  /* ‚úÖ Esconde navbar do base somente nesta p√°gina */
  body > header,
  body > nav,
  #navbar, #topbar, #mainNav, #siteNav,
  .navbar, .topbar, .site-header, .site-nav, .main-nav{
    display: none !important;
  }

  /* ‚úÖ Desativa scroll normal do body (scroll fica no viewer/right) */
  html, body { height: 100%; overflow: hidden; }

  /* Anti sele√ß√£o/c√≥pia (dificulta) */
  #contentShell, #contentShell *{ -webkit-user-select:none; user-select:none; }
  img{ -webkit-user-drag:none; user-drag:none; }

  /* impede scroll/puxar do browser dentro do viewer */
  #contentShell{
    touch-action: none;
    overscroll-behavior: contain;
  }

  /* Viewer: zoom/pan via transform */
  #contentBox{
    transform-origin: 0 0;
    will-change: transform;
    position: relative;
  }

  #contentBox img{
    display:block;
    width:100%;
    height:auto;
    pointer-events: none;
  }

  .img-error{
    border:1px solid rgba(225,6,0,.28);
    background: rgba(225,6,0,.08);
    border-radius: 16px;
    padding: 16px;
  }

  /* Pins */
  .pinWrap{
    position:absolute;
    transform: translate(-50%,-50%);
    pointer-events: auto;
    z-index: 9999;
  }
  .pin{
    width: 14px;
    height: 14px;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,.85);
    background: rgba(225,6,0,.92);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    cursor: pointer;
  }
  .pin-label{
    position:absolute;
    transform: translate(10px,-18px);
    max-width: 240px;
    padding: 8px 10px;
    border-radius: 12px;
    background: rgba(0,0,0,.78);
    border: 1px solid rgba(255,255,255,.10);
    color: rgba(255,255,255,.92);
    font-size: 12px;
    line-height: 1.2;
    white-space: normal;
    word-break: break-word;
    z-index: 10000;
    pointer-events: none;
  }

  .c-item{
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.22);
    border-radius: 14px;
    padding: 10px 12px;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
/* =========================
   CSRF + fetch
   ========================= */
function getCookie(name){
  const v = document.cookie.split(";").map(s=>s.trim());
  for(const c of v){
    if(c.startsWith(name+"=")) return decodeURIComponent(c.slice(name.length+1));
  }
  return null;
}
async function apiFetch(url, opts={}){
  const headers = new Headers(opts.headers || {});
  opts.credentials = "same-origin";
  const method = (opts.method || "GET").toUpperCase();
  if(["POST","PUT","PATCH","DELETE"].includes(method)){
    const csrf = getCookie("csrftoken");
    if(csrf) headers.set("X-CSRFToken", csrf);
    if(!headers.get("Content-Type")) headers.set("Content-Type","application/json");
  }
  opts.headers = headers;
  return fetch(url, opts);
}

/* =========================
   Helpers
   ========================= */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function pick(data, keys, fallback=null){
  for(const k of keys){
    if(data && data[k] !== undefined && data[k] !== null && data[k] !== "") return data[k];
  }
  return fallback;
}
function nowStamp(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function lsKeyComments(bookId, page){ return `owlsight:comments:${bookId}:${page}`; }
function lsKeyAnnos(bookId, page){ return `owlsight:annos:${bookId}:${page}`; }

/* =========================
   Drawer
   ========================= */
const drawerOverlay = document.getElementById("drawerOverlay");
const drawerPanel = document.getElementById("drawerPanel");
const openDrawerBtn = document.getElementById("openDrawerBtn");
const closeDrawerBtn = document.getElementById("closeDrawerBtn");

function openDrawer(){
  drawerOverlay.classList.remove("hidden");
  drawerPanel.classList.remove("hidden");
}
function closeDrawer(){
  drawerOverlay.classList.add("hidden");
  drawerPanel.classList.add("hidden");
}
if(openDrawerBtn) openDrawerBtn.addEventListener("click", openDrawer);
if(closeDrawerBtn) closeDrawerBtn.addEventListener("click", closeDrawer);
if(drawerOverlay) drawerOverlay.addEventListener("click", closeDrawer);

/* =========================
   Anti-c√≥pia (dificulta)
   ========================= */
(function harden(){
  document.addEventListener("contextmenu", (e)=>{ if(e.target.closest("#contentShell")) e.preventDefault(); });
  document.addEventListener("dragstart", (e)=>{ if(e.target.closest("#contentShell")) e.preventDefault(); });
  const blur = document.getElementById("privacyBlur");
  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden) blur.classList.remove("hidden");
    else blur.classList.add("hidden");
  });
})();

/* =========================
   Watermark
   ========================= */
function setWatermarkOverlay({ bookTitle, pageNum, userLabel }){
  const overlay = document.getElementById("wmOverlay");
  const text = `${bookTitle} ‚Ä¢ ${userLabel} ‚Ä¢ p.${pageNum} ‚Ä¢ Owlsight`;
  const safe = escapeHtml(text);

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="640" height="420">
    <defs><style>
      .t{font-family: Arial, sans-serif; font-size: 18px; fill: rgba(255,255,255,0.12);}
    </style></defs>
    <g transform="translate(40,250) rotate(-24)">
      <text x="0" y="0" class="t">${safe}</text>
      <text x="0" y="42" class="t">${safe}</text>
      <text x="0" y="84" class="t">${safe}</text>
    </g>
  </svg>`.trim();

  const dataUrl = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  overlay.style.backgroundImage = `url("${dataUrl}")`;
  overlay.style.backgroundRepeat = "repeat";
  overlay.style.backgroundSize = "640px 420px";
  overlay.style.opacity = "1";
}

/* =========================
   Zoom/Pan
   ========================= */
const contentShell = document.getElementById("contentShell");
const contentBox = document.getElementById("contentBox");

let zoom = 1;
let minZoom = 0.5;
let maxZoom = 4;
let tx = 0;
let ty = 0;
let panEnabled = false;
let annotateEnabled = false;

function applyTransform(){
  contentBox.style.transform = `translate(${tx}px, ${ty}px) scale(${zoom})`;
}
function zoomBy(factor){
  const prev = zoom;
  let next = zoom * factor;
  next = Math.max(minZoom, Math.min(maxZoom, next));

  const rect = contentShell.getBoundingClientRect();
  const cx = rect.width / 2;
  const cy = rect.height / 2;

  tx = cx - (cx - tx) * (next / prev);
  ty = cy - (cy - ty) * (next / prev);

  zoom = next;
  applyTransform();
}
function resetZoom(){
  zoom = 1;
  tx = 0;
  ty = 0;
  applyTransform();
}
function setPan(enabled){
  panEnabled = enabled;
  document.getElementById("panToggleBtn").textContent = enabled ? "M√£o: ON" : "M√£o: OFF";
}
function setAnnotate(enabled){
  annotateEnabled = enabled;
  document.getElementById("annotateToggleBtn").textContent = enabled ? "Anotar: ON" : "Anotar: OFF";
}
document.getElementById("zoomInBtnR").onclick = ()=>zoomBy(1.15);
document.getElementById("zoomOutBtnR").onclick = ()=>zoomBy(1/1.15);
document.getElementById("resetBtnR").onclick = resetZoom;
document.getElementById("panToggleBtn").onclick = ()=>setPan(!panEnabled);
document.getElementById("annotateToggleBtn").onclick = ()=>setAnnotate(!annotateEnabled);
setPan(false);
setAnnotate(false);

/* Mobile pinch/pan */
const pointers = new Map();
let lastPinchDist = null;
let lastPinchCenter = null;
let isDragging = false, dragStartX=0, dragStartY=0, dragStartTX=0, dragStartTY=0;

function _dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function _center(a,b){ return { x:(a.x+b.x)/2, y:(a.y+b.y)/2 }; }

function onPointerDown(e){
  e.preventDefault();
  contentShell.setPointerCapture?.(e.pointerId);
  pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

  if(pointers.size === 2){
    isDragging = false;
    const pts = Array.from(pointers.values());
    lastPinchDist = _dist(pts[0], pts[1]);
    lastPinchCenter = _center(pts[0], pts[1]);
    return;
  }
  if(pointers.size === 1){
    if(annotateEnabled) return;
    if(!panEnabled) return;
    isDragging = true;
    dragStartX = e.clientX; dragStartY = e.clientY;
    dragStartTX = tx; dragStartTY = ty;
  }
}
function onPointerMove(e){
  if(!pointers.has(e.pointerId)) return;
  e.preventDefault();
  pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

  if(pointers.size === 2){
    const pts = Array.from(pointers.values());
    const d = _dist(pts[0], pts[1]);
    const c = _center(pts[0], pts[1]);

    if(lastPinchDist && lastPinchCenter){
      const ratio = d / lastPinchDist;
      const prev = zoom;

      let next = zoom * ratio;
      next = Math.max(minZoom, Math.min(maxZoom, next));

      const rect = contentShell.getBoundingClientRect();
      const px = c.x - rect.left;
      const py = c.y - rect.top;

      tx = px - (px - tx) * (next / prev);
      ty = py - (py - ty) * (next / prev);

      tx += (c.x - lastPinchCenter.x);
      ty += (c.y - lastPinchCenter.y);

      zoom = next;
      applyTransform();
    }
    lastPinchDist = d;
    lastPinchCenter = c;
    return;
  }

  if(pointers.size === 1 && isDragging){
    const dx = e.clientX - dragStartX;
    const dy = e.clientY - dragStartY;
    tx = dragStartTX + dx;
    ty = dragStartTY + dy;
    applyTransform();
  }
}
function onPointerUp(e){
  e.preventDefault();
  pointers.delete(e.pointerId);
  if(pointers.size < 2){ lastPinchDist = null; lastPinchCenter = null; }
  if(pointers.size === 0){ isDragging = false; }
}

contentShell.addEventListener("pointerdown", onPointerDown, { passive:false });
contentShell.addEventListener("pointermove", onPointerMove, { passive:false });
contentShell.addEventListener("pointerup", onPointerUp, { passive:false });
contentShell.addEventListener("pointercancel", onPointerUp, { passive:false });

/* =========================
   Read + Comments + Annotations
   ========================= */
const bookId = Number("{{ book_id }}");
let page = Number("{{ page_number }}");
let maxPages = 1;
let currentUserLabel = "user";

async function fetchMe(){
  const res = await apiFetch("/api/auth/me/");
  if(!res.ok) return null;
  return res.json().catch(()=>null);
}

function coverHtml(coverUrl){
  if(!coverUrl){
    return `<div class="w-full h-full grid place-items-center text-xs" style="color: rgba(255,255,255,.45)">Sem capa</div>`;
  }
  return `
    <img
      src="${coverUrl}"
      class="w-full h-full object-cover"
      draggable="false"
      onerror="this.outerHTML='<div class=&quot;w-full h-full grid place-items-center text-xs&quot; style=&quot;color: rgba(255,255,255,.45)&quot;>Capa indispon√≠vel</div>'"
    />
  `;
}

function renderHeader(whereId, bookTitle, bookType, coverUrl, totalPages, limitPage){
  const el = document.getElementById(whereId);
  if(!el) return;

  el.innerHTML = `
    <div class="w-24 aspect-[3/4] rounded-2xl overflow-hidden poster" style="border:1px solid rgba(255,255,255,.10)">
      ${coverHtml(coverUrl)}
    </div>
    <div class="flex-1">
      <div class="font-black text-lg leading-tight">${escapeHtml(bookTitle)}</div>
      <div class="text-xs mt-1" style="color: rgba(255,255,255,.65)">
        Tipo: <b>${escapeHtml(String(bookType).toUpperCase())}</b>
      </div>
      <div class="text-xs mt-2" style="color: rgba(255,255,255,.60)">
        Folha <b>${page}</b>
        ‚Ä¢ Limite: <b>${limitPage || "-"}</b>
        ‚Ä¢ Total: <b>${totalPages || "-"}</b>
      </div>
    </div>
  `;
}

function renderPageImageOrError(pageImg, bookTitle){
  const img = new Image();
  img.src = pageImg;
  img.className = "w-full rounded-2xl";
  img.draggable = false;

  img.onload = async () => {
    contentBox.innerHTML = "";
    contentBox.appendChild(img);
    resetZoom();
    await loadAndRenderAnnos();
  };

  img.onerror = () => {
    contentBox.innerHTML = `
      <div class="img-error">
        <div class="text-lg font-black">A imagem da p√°gina falhou carregar</div>
        <div class="text-sm mt-2" style="color: rgba(255,255,255,.75)">
          O link (page_image) est√° inv√°lido/expirado ou sem permiss√£o.
        </div>
        <div class="text-xs mt-3" style="color: rgba(255,255,255,.70)">
          <div><b>Livro:</b> ${escapeHtml(bookTitle)}</div>
          <div class="mt-1"><b>URL:</b></div>
          <div class="mt-1" style="word-break: break-all; color: rgba(255,255,255,.60)">${escapeHtml(pageImg)}</div>
        </div>
      </div>
    `;
  };

  contentBox.innerHTML = `<div class="p-10 text-center" style="color: rgba(255,255,255,.65)">Carregando imagem...</div>`;
}

/* ---------- Comments (API with fallback) ---------- */
function loadCommentsLS(){
  try{
    const raw = localStorage.getItem(lsKeyComments(bookId, page));
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function saveCommentsLS(arr){
  localStorage.setItem(lsKeyComments(bookId, page), JSON.stringify(arr));
}

async function getComments(){
  // tenta API real
  try{
    const res = await apiFetch(`/api/books/${bookId}/comments/?page=${page}`);
    if(res.ok){
      const arr = await res.json().catch(()=>[]);
      if(Array.isArray(arr)) return arr;
    }
  }catch(e){}
  // fallback localStorage
  return loadCommentsLS().map(c => ({
    text: c.text, user_label: c.user, created_at_display: c.at
  }));
}

async function postComment(text){
  const t = (text||"").trim();
  if(!t) return;

  // tenta API
  try{
    const res = await apiFetch(`/api/books/${bookId}/comments/`, {
      method:"POST",
      body: JSON.stringify({ page_number: page, text: t })
    });
    if(res.ok) return true;
  }catch(e){}

  // fallback localStorage
  const arr = loadCommentsLS();
  arr.unshift({ text: t, at: nowStamp(), user: currentUserLabel });
  saveCommentsLS(arr);
  return true;
}

function renderCommentsUI(arr){
  const list = document.getElementById("commentsList");
  const listM = document.getElementById("commentsListM");
  const count = document.getElementById("commentCount");
  const countM = document.getElementById("commentCountM");

  const html = (arr||[]).map(c => `
    <div class="c-item">
      <div class="text-xs" style="color: rgba(255,255,255,.65)">
        ${escapeHtml(c.created_at_display || "")} ‚Ä¢ ${escapeHtml(c.user_label || "")}
      </div>
      <div class="text-sm mt-1" style="color: rgba(255,255,255,.92)">${escapeHtml(c.text || "")}</div>
    </div>
  `).join("");

  const empty = `<div class="text-xs" style="color: rgba(255,255,255,.55)">Sem coment√°rios ainda.</div>`;
  if(list) list.innerHTML = html || empty;
  if(listM) listM.innerHTML = html || empty;
  if(count) count.textContent = String((arr||[]).length);
  if(countM) countM.textContent = String((arr||[]).length);
}

function bindCommentButtons(){
  const btn = document.getElementById("addCommentBtn");
  const txt = document.getElementById("commentText");
  if(btn && txt){
    btn.onclick = async ()=>{
      await postComment(txt.value);
      txt.value = "";
      const arr = await getComments();
      renderCommentsUI(arr);
    };
  }
  const btnM = document.getElementById("addCommentBtnM");
  const txtM = document.getElementById("commentTextM");
  if(btnM && txtM){
    btnM.onclick = async ()=>{
      await postComment(txtM.value);
      txtM.value = "";
      const arr = await getComments();
      renderCommentsUI(arr);
    };
  }
}

/* ---------- Annotations (API with fallback) ---------- */
function loadAnnosLS(){
  try{
    const raw = localStorage.getItem(lsKeyAnnos(bookId, page));
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function saveAnnosLS(arr){
  localStorage.setItem(lsKeyAnnos(bookId, page), JSON.stringify(arr));
}

async function getAnnos(){
  try{
    const res = await apiFetch(`/api/books/${bookId}/annotations/?page=${page}`);
    if(res.ok){
      const arr = await res.json().catch(()=>[]);
      if(Array.isArray(arr)) return arr;
    }
  }catch(e){}
  // fallback LS
  return loadAnnosLS().map(a => ({
    x:a.x, y:a.y, text:a.text, user_label:a.user, created_at_display:a.at, mine:true
  }));
}

async function postAnno(x, y, text){
  const t = (text||"").trim();
  if(!t) return;

  try{
    const res = await apiFetch(`/api/books/${bookId}/annotations/`, {
      method:"POST",
      body: JSON.stringify({ page_number: page, x, y, text: t })
    });
    if(res.ok) return true;
  }catch(e){}

  // fallback LS
  const arr = loadAnnosLS();
  arr.unshift({ x, y, text: t, at: nowStamp(), user: currentUserLabel });
  saveAnnosLS(arr);
  return true;
}

function renderAnnos(arr){
  contentBox.querySelectorAll(".pinWrap").forEach(n=>n.remove());

  (arr||[]).forEach((a)=>{
    const wrap = document.createElement("div");
    wrap.className = "pinWrap";
    wrap.style.left = (a.x * 100) + "%";
    wrap.style.top  = (a.y * 100) + "%";

    const pin = document.createElement("div");
    pin.className = "pin";

    const label = document.createElement("div");
    label.className = "pin-label";
    label.style.display = "none";
    label.innerHTML = `
      <div style="font-weight:800">${escapeHtml(a.text || "")}</div>
      <div style="margin-top:4px;color:rgba(255,255,255,.65)">
        ${escapeHtml(a.created_at_display || "")} ‚Ä¢ ${escapeHtml(a.user_label || "")}
      </div>
    `;

    // ‚úÖ importante: n√£o deixar o click criar novo pin
    pin.addEventListener("click", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      label.style.display = (label.style.display === "none") ? "block" : "none";
    });

    wrap.appendChild(pin);
    wrap.appendChild(label);
    contentBox.appendChild(wrap);
  });
}

async function loadAndRenderAnnos(){
  const arr = await getAnnos();
  renderAnnos(arr);
}

/* ---------- Gate (restri√ß√µes) ---------- */
function showBlocker(html){
  const b = document.getElementById("blocker");
  const bm = document.getElementById("blockerM");
  if(b){ b.innerHTML = html; b.classList.remove("hidden"); }
  if(bm){ bm.innerHTML = html; bm.classList.remove("hidden"); }
}
function hideBlocker(){
  const b = document.getElementById("blocker");
  const bm = document.getElementById("blockerM");
  if(b){ b.classList.add("hidden"); b.innerHTML=""; }
  if(bm){ bm.classList.add("hidden"); bm.innerHTML=""; }
}

/* ---------- Load page ---------- */
async function loadPage(){
  const debugBox = document.getElementById("debugBox");
  const debugBoxM = document.getElementById("debugBoxM");
  const msg = document.getElementById("msg");
  const msgM = document.getElementById("msgM");

  if(msg) msg.textContent = "";
  if(msgM) msgM.textContent = "";
  hideBlocker();

  const me = await fetchMe();
  if(!me){
    window.location.href = `/login/?next=${encodeURIComponent(window.location.pathname)}`;
    return;
  }
  currentUserLabel = (me.email || me.username || me.user || me.name || "user");

  const res = await apiFetch(`/api/read/${bookId}/${page}/`);
  const data = await res.json().catch(()=>({}));

  const dbg = JSON.stringify({ status: res.status, data }, null, 2);
  if(debugBox) debugBox.textContent = dbg;
  if(debugBoxM) debugBoxM.textContent = dbg;

  // ‚úÖ Se backend bloqueou (403) e trouxe payload
  if(res.status === 403 && data){
    const totalPages = Number(pick(data, ["total_pages","totalPages","pages_total","pages","total"], 0)) || 0;
    const limitPage  = Number(pick(data, ["allowed_until_page","limit_until_page","allowedUntilPage","limitPage","allowed_until","limit_until"], 0)) || 0;
    const bookTitle = pick(data, ["title","book_title","name","book"], "Livro");
    const bookType  = pick(data, ["book_type","type","tier"], "");
    const coverUrl = pick(data, ["cover_url","cover","coverUrl","cover_image"], "");

    if(totalPages > 0) maxPages = totalPages;
    renderHeader("header", bookTitle, bookType, coverUrl, totalPages, limitPage);
    renderHeader("headerMobile", bookTitle, bookType, coverUrl, totalPages, limitPage);

    const gate = data.gate || data.block_reason || data.reason || "";
    if(gate === "PAY"){
      showBlocker(`
        <div class="font-semibold">Livro Premium</div>
        <div class="text-sm mt-1" style="color: rgba(255,255,255,.78)">
          Voc√™ atingiu o limite gratuito (<b>${limitPage}</b>). Para continuar, √© preciso pagar.
        </div>
        <div class="mt-3 grid gap-2">
          <button class="btn-red px-4 py-2 rounded-xl text-sm font-semibold">1 semana ‚Äî 100 MZN</button>
          <button class="btn-red px-4 py-2 rounded-xl text-sm font-semibold">1 m√™s ‚Äî 200 MZN</button>
          <button class="btn-red px-4 py-2 rounded-xl text-sm font-semibold">3 meses ‚Äî 300 MZN</button>
          <button class="btn-red px-4 py-2 rounded-xl text-sm font-semibold">6 meses ‚Äî 500 MZN</button>
          <button class="btn-red px-4 py-2 rounded-xl text-sm font-semibold">1 ano ‚Äî 1000 MZN</button>
        </div>
        <div class="text-xs mt-2" style="color: rgba(255,255,255,.55)">
          (Integra√ß√£o de pagamento real vamos ligar no pr√≥ximo passo)
        </div>
      `);
    }else{
      showBlocker(`
        <div class="font-semibold">Partilha necess√°ria</div>
        <div class="text-sm mt-1" style="color: rgba(255,255,255,.78)">
          Voc√™ atingiu o limite gratuito (<b>${limitPage}</b>). Partilhe o link do livro para continuar.
        </div>
        <div class="mt-3">
          <button class="btn-red px-4 py-2 rounded-xl text-sm font-semibold" onclick="shareAndContinue()">
            Partilhar e continuar
          </button>
        </div>
      `);
    }

    contentBox.innerHTML = `
      <div class="p-10 text-center">
        <div class="text-lg font-black">Leitura bloqueada</div>
        <div class="text-sm mt-2" style="color: rgba(255,255,255,.65)">
          Use o painel √† esquerda/Drawer para desbloquear.
        </div>
      </div>
    `;
    return;
  }

  if(res.status === 401){
    window.location.href = `/login/?next=${encodeURIComponent(window.location.pathname)}`;
    return;
  }

  const totalPages = Number(pick(data, ["total_pages","totalPages","pages_total","pages","total"], 0)) || 0;
  const limitPage  = Number(pick(data, ["allowed_until_page","limit_until_page","allowedUntilPage","limitPage","allowed_until","limit_until"], 0)) || 0;

  const bookTitle = pick(data, ["title","book_title","name","book"], "Livro");
  const bookType  = pick(data, ["book_type","type","tier"], "");
  const coverUrl = pick(data, ["cover_url","cover","coverUrl","cover_image","book_cover"], "");
  const pageImg = pick(data, ["page_image","pageImage","image","image_url","img","url","page_url"], "");

  if(totalPages > 0) maxPages = totalPages;

  renderHeader("header", bookTitle, bookType, coverUrl, totalPages, limitPage);
  renderHeader("headerMobile", bookTitle, bookType, coverUrl, totalPages, limitPage);

  if(!pageImg){
    contentBox.innerHTML = `
      <div class="p-10 text-center">
        <div class="text-lg font-black">N√£o veio a imagem da p√°gina</div>
        <div class="text-sm mt-2" style="color: rgba(255,255,255,.65)">
          O backend precisa enviar <b>page_image</b>. Veja no Debug acima quais campos est√£o vindo.
        </div>
      </div>
    `;
    return;
  }

  renderPageImageOrError(pageImg, bookTitle);

  const comments = await getComments();
  renderCommentsUI(comments);

  setWatermarkOverlay({ bookTitle, pageNum: page, userLabel: currentUserLabel });
}

/* Share helper (front only; backend unlock voc√™ liga depois) */
window.shareAndContinue = async function(){
  try{
    const url = window.location.href;
    if(navigator.share){
      await navigator.share({ title:"Owlsight", text:"Veja este livro na Owlsight", url });
    }else{
      await navigator.clipboard.writeText(url);
    }
    // aqui voc√™ vai ligar o endpoint real de unlock depois (modo profissional B)
    // por enquanto apenas tenta recarregar
    await loadPage();
  }catch(e){
    await loadPage();
  }
}

/* Navigation */
function goPrev(){ if(page > 1){ page--; loadPage(); } }
function goNext(){
  if(page < maxPages){ page++; loadPage(); }
}
document.getElementById("prevBtn").onclick = goPrev;
document.getElementById("nextBtn").onclick = goNext;
document.getElementById("prevBtnM").onclick = goPrev;
document.getElementById("nextBtnM").onclick = goNext;

/* Create annotation */
contentShell.addEventListener("click", async (e)=>{
  if(!annotateEnabled) return;

  const img = contentBox.querySelector("img");
  if(!img) return;

  const rect = contentBox.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;

  if(x < 0 || x > 1 || y < 0 || y > 1) return;

  const note = prompt("Texto da anota√ß√£o:");
  if(note === null) return;

  await postAnno(x, y, note);
  await loadAndRenderAnnos();
});

/* Start */
bindCommentButtons();
loadPage();
</script>
{% endblock %}