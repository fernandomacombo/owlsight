{% load static %}
<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>{% block title %}Owlsight{% endblock %}</title>

  <style>
    :root{
      --bg0:#050506;
      --bg1:#0b0b10;
      --panel: rgba(18,18,22,.70);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --red:#E10600;
      --red2:#8A0000;
    }

    html,body{height:100%;}
    body{
      color: var(--text);
      background:
        radial-gradient(900px 520px at 12% 8%, rgba(225,6,0,.18), transparent 60%),
        radial-gradient(820px 520px at 90% 10%, rgba(225,6,0,.10), transparent 55%),
        radial-gradient(700px 520px at 55% 90%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .glass{
      background: var(--panel);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(14px);
    }

    .soft-shadow{ box-shadow: 0 18px 60px rgba(0,0,0,.55); }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      transition: transform .15s ease, border-color .15s ease, background .15s ease, opacity .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btn-red{
      border: 1px solid rgba(225,6,0,.45);
      background: linear-gradient(180deg, rgba(225,6,0,.95), rgba(138,0,0,.95));
      box-shadow: 0 10px 30px rgba(225,6,0,.20);
    }
    .btn-red:hover{ opacity: .96; }

    .input{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      outline: none;
    }
    .input:focus{
      border-color: rgba(225,6,0,.55);
      box-shadow: 0 0 0 4px rgba(225,6,0,.12);
    }

    .poster{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
    }

    .fade-in{ animation: fadeIn .20s ease-out both; }
    @keyframes fadeIn{ from{ opacity:0; transform: translateY(6px);} to{opacity:1; transform:none;} }

    .scrollbar::-webkit-scrollbar{ width: 10px; height: 10px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius: 999px; }
    .scrollbar::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.18); }

    /* Drawer */
    .drawer-backdrop{
      position: fixed;
      inset: 0;
      z-index: 60;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      display:none;
    }
    .drawer-backdrop.open{ display:block; }

    .drawer{
      position:absolute;
      top:0; right:0;
      width: min(360px, 92vw);
      height:100%;
      background: rgba(12,12,12,.96);
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: -20px 0 80px rgba(0,0,0,.65);
      padding: 14px;
      transform: translateX(100%);
      transition: transform .18s ease;
    }
    .drawer-backdrop.open .drawer{ transform: translateX(0); }

    .drawer a, .drawer button{
      width: 100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.90);
      margin-top: 10px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
    }
    .drawer a:hover, .drawer button:hover{
      border-color: rgba(225,6,0,.25);
      background: rgba(255,255,255,.08);
    }
    .drawer .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .drawer .x{
      width: 42px; height: 42px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #fff;
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="min-h-screen">
  <!-- Top bar -->
  <header class="sticky top-0 z-30">
    <div class="glass soft-shadow">
      <div class="max-w-8xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
        <a href="/" class="flex items-center gap-3 min-w-0">
          <img src="{% static 'frontend/images/logo.png' %}" alt="Owlsight" class="h-9 w-auto object-contain" />
          <div class="leading-tight min-w-0">
            <div class="font-extrabold tracking-wide truncate">Owlsight</div>
            <div class="text-xs truncate" style="color: var(--muted);">Biblioteca • Ler além</div>
          </div>
        </a>

        {% url 'dashboard:home' as dash_url %}

        <!-- Desktop nav (>= sm) -->
        <nav class="hidden sm:flex items-center gap-2">
          <a href="/categories/" class="btn px-3 py-2 rounded-xl text-sm">Categoria</a>
          <a href="/favorites/" class="btn px-3 py-2 rounded-xl text-sm">Favoritos</a>

          {% if request.user.is_authenticated %}
            <a href="/profile/" class="btn px-3 py-2 rounded-xl text-sm">Minha Conta</a>

            {% if request.user.is_staff or request.user.is_superuser %}
              {% if dash_url %}
                <a href="{{ dash_url }}" class="btn-red px-3 py-2 rounded-xl text-sm font-semibold">Admin</a>
              {% endif %}
            {% endif %}

            <form action="/api/auth/logout/" method="post" class="inline">
              {% csrf_token %}
              <button type="submit" class="btn px-3 py-2 rounded-xl text-sm">Sair</button>
            </form>
          {% else %}
            <a href="/login/" class="btn-red px-3 py-2 rounded-xl text-sm font-semibold">Login</a>
          {% endif %}
        </nav>

        <!-- Mobile hamburger (< sm) -->
        <button class="sm:hidden btn px-3 py-2 rounded-xl text-sm" type="button" onclick="openDrawer()" aria-label="Menu">
          ☰
        </button>
      </div>
    </div>
  </header>

  <!-- Drawer (mobile) -->
  <div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer(event)">
    <div class="drawer" onclick="event.stopPropagation()">
      <div class="head">
        <div class="text-white/90 font-extrabold">Menu</div>
        <button class="x" type="button" onclick="closeDrawer(event)">✕</button>
      </div>

      <a href="/categories/">Categoria <span>›</span></a>
      <a href="/favorites/">Favoritos <span>›</span></a>

      {% if request.user.is_authenticated %}
        <a href="/profile/">Minha Conta <span>›</span></a>

        {% if request.user.is_staff or request.user.is_superuser %}
          {% if dash_url %}
            <a href="{{ dash_url }}">Admin <span>›</span></a>
          {% endif %}
        {% endif %}

        <form action="/api/auth/logout/" method="post">
          {% csrf_token %}
          <button type="submit">Sair <span>›</span></button>
        </form>
      {% else %}
        <a href="/login/">Login <span>›</span></a>
      {% endif %}
    </div>
  </div>

  <main class="max-w-8xl mx-auto px-4 py-6">
    {% block content %}{% endblock %}
  </main>

  <footer class="max-w-8xl mx-auto px-4 pb-8">
    <div class="text-xs" style="color: var(--muted);">
      © <span id="y"></span> Owlsight • Preto • Vermelho • Branco
    </div>
  </footer>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();

    function openDrawer(){ document.getElementById("drawerBackdrop").classList.add("open"); }
    function closeDrawer(e){
      if(e) e.stopPropagation();
      document.getElementById("drawerBackdrop").classList.remove("open");
    }
    document.addEventListener("click", (e) => {
      const a = e.target.closest("#drawerBackdrop a");
      if(a) closeDrawer();
    });
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeDrawer();
    });

    // ===== Cookies + CSRF + fetch (reutilizável em todas páginas) =====
    function getCookie(name) {
      const m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      return m ? decodeURIComponent(m[2]) : null;
    }
    function isUnsafe(method) {
      return ["POST","PUT","PATCH","DELETE"].includes((method || "GET").toUpperCase());
    }
    async function apiFetch(url, options = {}) {
      const opts = { ...options };
      opts.credentials = "include";
      opts.headers = opts.headers || {};
      opts.headers["Accept"] = "application/json";
      if (isUnsafe(opts.method)) {
        const csrf = getCookie("csrftoken");
        if (csrf) opts.headers["X-CSRFToken"] = csrf;
      }
      return fetch(url, opts);
    }
    let CSRF_READY = false;
    async function ensureCsrf(){
      if (CSRF_READY) return;
      const res = await apiFetch("/api/csrf/");
      if (res.ok) CSRF_READY = true;
    }
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>